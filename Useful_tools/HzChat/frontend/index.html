<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CHATTER â€” Live Chat</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    /* â”€â”€ Reset & Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:        #0a0a0f;
      --surface:   #111118;
      --border:    #1e1e2e;
      --accent:    #7c6af7;
      --accent2:   #f76a8c;
      --green:     #4ade80;
      --text:      #e2e2f0;
      --muted:     #5a5a78;
      --radius:    14px;
      --font-ui:   'Syne', sans-serif;
      --font-mono: 'Space Mono', monospace;
    }

    html, body { height: 100%; overflow: hidden; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-ui);
      display: flex;
      flex-direction: column;
    }

    /* â”€â”€ Noise overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.03'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ Login Screen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #login-screen {
      position: fixed;
      inset: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      flex-direction: column;
      gap: 0;
      transition: opacity .4s, transform .4s;
    }

    #login-screen.hidden {
      opacity: 0;
      transform: translateY(-24px);
      pointer-events: none;
    }

    .login-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 48px 40px;
      width: 100%;
      max-width: 420px;
      display: flex;
      flex-direction: column;
      gap: 24px;
      position: relative;
      overflow: hidden;
    }

    .login-box::before {
      content: '';
      position: absolute;
      top: -60px; left: -60px;
      width: 200px; height: 200px;
      background: radial-gradient(circle, rgba(124,106,247,.25) 0%, transparent 70%);
      pointer-events: none;
    }

    .login-logo {
      font-size: 2.4rem;
      font-weight: 800;
      letter-spacing: -2px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-sub {
      color: var(--muted);
      font-size: .9rem;
      margin-top: -16px;
    }

    .login-box label {
      font-size: .75rem;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--muted);
    }

    .login-box input {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: .95rem;
      padding: 12px 16px;
      margin-top: 8px;
      outline: none;
      transition: border-color .2s;
    }

    .login-box input:focus { border-color: var(--accent); }

    .btn-join {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      border-radius: 10px;
      color: #fff;
      cursor: pointer;
      font-family: var(--font-ui);
      font-size: 1rem;
      font-weight: 700;
      padding: 14px;
      transition: opacity .2s, transform .15s;
      letter-spacing: .5px;
    }

    .btn-join:hover { opacity: .88; transform: translateY(-1px); }
    .btn-join:active { transform: translateY(0); }

    #login-error {
      color: var(--accent2);
      font-size: .82rem;
      min-height: 18px;
      font-family: var(--font-mono);
    }

    /* â”€â”€ App Shell â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #app {
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    /* â”€â”€ Top Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #topbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      background: rgba(17,17,24,.85);
      backdrop-filter: blur(12px);
      flex-shrink: 0;
    }

    .topbar-logo {
      font-size: 1.4rem;
      font-weight: 800;
      letter-spacing: -1px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    #status-dot {
      width: 8px; height: 8px;
      border-radius: 50%;
      background: var(--muted);
      transition: background .3s;
    }
    #status-dot.connected { background: var(--green); box-shadow: 0 0 6px var(--green); }
    #status-dot.error { background: var(--accent2); }

    #status-text {
      font-size: .75rem;
      color: var(--muted);
      font-family: var(--font-mono);
    }

    #online-count {
      font-size: .75rem;
      color: var(--muted);
      background: var(--border);
      border-radius: 20px;
      padding: 4px 12px;
    }

    /* â”€â”€ Main Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #sidebar {
      width: 220px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      overflow: hidden;
    }

    .sidebar-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-title {
      font-size: .68rem;
      font-weight: 700;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 12px;
    }

    #user-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
      overflow-y: auto;
      padding: 16px;
      flex: 1;
    }

    #user-list li {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: .85rem;
      cursor: pointer;
      padding: 6px 8px;
      border-radius: 8px;
      transition: background .15s;
      color: var(--text);
    }

    #user-list li:hover { background: var(--border); }
    #user-list li.me { color: var(--accent); }

    .user-avatar {
      width: 28px; height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: .7rem;
      font-weight: 700;
      flex-shrink: 0;
    }

    .online-pip {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 4px var(--green);
      margin-left: auto;
      flex-shrink: 0;
    }

    /* â”€â”€ Chat Area â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #dm-banner {
      background: rgba(124,106,247,.12);
      border-bottom: 1px solid rgba(124,106,247,.2);
      padding: 8px 20px;
      font-size: .8rem;
      display: flex;
      align-items: center;
      gap: 8px;
      display: none;
    }

    #dm-banner.visible { display: flex; }

    #dm-banner span { color: var(--accent); font-weight: 700; }
    #dm-close {
      margin-left: auto;
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
    }

    /* Messages */
    #messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px 20px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      scroll-behavior: smooth;
    }

    #messages::-webkit-scrollbar { width: 4px; }
    #messages::-webkit-scrollbar-track { background: transparent; }
    #messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

    .msg {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 4px 0;
      animation: msgIn .2s ease;
    }

    @keyframes msgIn {
      from { opacity: 0; transform: translateY(8px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .msg-header {
      display: flex;
      align-items: baseline;
      gap: 10px;
    }

    .msg-name {
      font-size: .78rem;
      font-weight: 700;
      letter-spacing: .5px;
    }

    .msg-time {
      font-size: .68rem;
      color: var(--muted);
      font-family: var(--font-mono);
    }

    .msg-text {
      font-size: .92rem;
      line-height: 1.55;
      color: var(--text);
      padding-left: 2px;
      word-break: break-word;
    }

    /* Group consecutive messages */
    .msg.grouped .msg-header { display: none; }
    .msg.grouped { padding-top: 0; }

    .msg.private .msg-text {
      background: rgba(247,106,140,.08);
      border-left: 2px solid var(--accent2);
      padding: 4px 10px;
      border-radius: 0 6px 6px 0;
    }

    .msg.system {
      align-items: center;
      padding: 8px 0;
    }

    .msg.system .msg-text {
      font-size: .72rem;
      color: var(--muted);
      font-family: var(--font-mono);
      background: var(--border);
      padding: 3px 12px;
      border-radius: 20px;
    }

    .msg.mine .msg-name { color: var(--accent); }

    /* Typing indicator */
    #typing-indicator {
      padding: 4px 20px 8px;
      font-size: .73rem;
      color: var(--muted);
      font-family: var(--font-mono);
      min-height: 24px;
    }

    .typing-dots {
      display: inline-flex;
      gap: 3px;
      vertical-align: middle;
    }
    .typing-dots span {
      width: 4px; height: 4px;
      border-radius: 50%;
      background: var(--muted);
      animation: dot 1.2s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: .2s; }
    .typing-dots span:nth-child(3) { animation-delay: .4s; }

    @keyframes dot {
      0%, 80%, 100% { transform: scale(.8); opacity: .4; }
      40% { transform: scale(1.2); opacity: 1; }
    }

    /* â”€â”€ Input Bar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #input-bar {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 10px;
      align-items: flex-end;
      flex-shrink: 0;
      background: rgba(17,17,24,.85);
      backdrop-filter: blur(12px);
    }

    #msg-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 12px;
      color: var(--text);
      font-family: var(--font-ui);
      font-size: .93rem;
      padding: 12px 16px;
      outline: none;
      resize: none;
      max-height: 120px;
      line-height: 1.5;
      transition: border-color .2s;
    }

    #msg-input:focus { border-color: var(--accent); }
    #msg-input::placeholder { color: var(--muted); }

    #send-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      border: none;
      border-radius: 12px;
      color: #fff;
      cursor: pointer;
      font-size: 1.1rem;
      width: 46px;
      height: 46px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity .2s, transform .15s;
      flex-shrink: 0;
    }
    #send-btn:hover { opacity: .85; transform: scale(1.05); }
    #send-btn:active { transform: scale(.97); }
    #send-btn:disabled { opacity: .35; cursor: not-allowed; }

    /* â”€â”€ Config Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #config-note {
      background: rgba(124,106,247,.1);
      border: 1px dashed rgba(124,106,247,.3);
      border-radius: 10px;
      color: var(--muted);
      font-family: var(--font-mono);
      font-size: .72rem;
      padding: 8px 14px;
      margin: 0 20px 12px;
      line-height: 1.6;
    }

    #config-note strong { color: var(--accent); }

    /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media (max-width: 600px) {
      #sidebar { display: none; }
      .login-box { margin: 16px; padding: 32px 24px; }
    }
  </style>
</head>
<body>

<!-- â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-screen">
  <div class="login-box">
    <div class="login-logo">CHATTER</div>
    <div class="login-sub">real-time Â· open Â· free</div>
    <div>
      <label for="server-url">Backend URL (Hugging Face Space)</label>
      <input id="server-url" type="text" placeholder="https://your-space.hf.space" />
    </div>
    <div>
      <label for="username-input">Your username</label>
      <input id="username-input" type="text" placeholder="coolname123" maxlength="20" />
    </div>
    <div id="login-error"></div>
    <button class="btn-join" id="join-btn">Join Chat â†’</button>
  </div>
</div>

<!-- â”€â”€ App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="app">
  <!-- Top bar -->
  <div id="topbar">
    <div class="topbar-logo">CHATTER</div>
    <div class="topbar-right">
      <div id="status-dot"></div>
      <div id="status-text">disconnected</div>
      <div id="online-count">0 online</div>
    </div>
  </div>

  <!-- Main layout -->
  <div id="main">
    <!-- Sidebar -->
    <div id="sidebar">
      <div class="sidebar-section">
        <div class="sidebar-title">Online Users</div>
      </div>
      <ul id="user-list"></ul>
    </div>

    <!-- Chat -->
    <div id="chat-area">
      <div id="dm-banner">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16v12H4z"/><polyline points="22,4 12,13 2,4"/></svg>
        Private message to <span id="dm-target"></span>
        <button id="dm-close" title="Back to global chat">âœ•</button>
      </div>

      <div id="config-note">
        ðŸ“¡ Connected to: <strong id="connected-url">â€”</strong> &nbsp;|&nbsp; Set your backend URL on login
      </div>

      <div id="messages"></div>
      <div id="typing-indicator"></div>

      <div id="input-bar">
        <textarea id="msg-input" rows="1" placeholder="Type a messageâ€¦ (Enter to send)"></textarea>
        <button id="send-btn" disabled>
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ws = null;
let myName = '';
let dmTarget = null;
let typingTimer = null;
let lastSender = null;
let lastTime = null;

const COLORS = [
  '#7c6af7','#f76a8c','#4ade80','#facc15',
  '#38bdf8','#fb923c','#a78bfa','#f472b6',
  '#34d399','#60a5fa'
];
const userColors = {};

function colorFor(name) {
  if (!userColors[name]) {
    const idx = Object.keys(userColors).length % COLORS.length;
    userColors[name] = COLORS[idx];
  }
  return userColors[name];
}

function initials(name) {
  return name.slice(0, 2).toUpperCase();
}

// â”€â”€ DOM Refs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const loginScreen  = document.getElementById('login-screen');
const serverInput  = document.getElementById('server-url');
const usernameInput= document.getElementById('username-input');
const loginError   = document.getElementById('login-error');
const joinBtn      = document.getElementById('join-btn');

const statusDot    = document.getElementById('status-dot');
const statusText   = document.getElementById('status-text');
const onlineCount  = document.getElementById('online-count');
const connectedUrl = document.getElementById('connected-url');

const userList     = document.getElementById('user-list');
const messages     = document.getElementById('messages');
const typingEl     = document.getElementById('typing-indicator');
const msgInput     = document.getElementById('msg-input');
const sendBtn      = document.getElementById('send-btn');
const dmBanner     = document.getElementById('dm-banner');
const dmTargetEl   = document.getElementById('dm-target');
const dmClose      = document.getElementById('dm-close');

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
joinBtn.addEventListener('click', connect);
usernameInput.addEventListener('keydown', e => { if (e.key === 'Enter') connect(); });

function connect() {
  const server = serverInput.value.trim().replace(/\/$/, '');
  const name   = usernameInput.value.trim().replace(/[^a-zA-Z0-9_-]/g, '');

  if (!server) { loginError.textContent = 'Please enter the backend URL.'; return; }
  if (!name || name.length < 2) { loginError.textContent = 'Username must be 2+ characters (letters, numbers, _ -).'; return; }

  loginError.textContent = 'Connectingâ€¦';
  joinBtn.disabled = true;

  const wsUrl = server.replace(/^http/, 'ws') + '/ws/' + name;

  try {
    ws = new WebSocket(wsUrl);
  } catch(e) {
    loginError.textContent = 'Invalid URL.';
    joinBtn.disabled = false;
    return;
  }

  ws.addEventListener('open', () => {
    myName = name;
    connectedUrl.textContent = server;
    loginScreen.classList.add('hidden');
    setStatus('connected');
    sendBtn.disabled = false;
    msgInput.focus();
  });

  ws.addEventListener('message', e => handleMessage(JSON.parse(e.data)));

  ws.addEventListener('close', () => {
    setStatus('disconnected');
    sendBtn.disabled = true;
    appendSystem('âš  Disconnected from server.');
  });

  ws.addEventListener('error', () => {
    loginError.textContent = 'Could not connect. Check the URL and CORS settings.';
    joinBtn.disabled = false;
    setStatus('error');
  });
}

// â”€â”€ Message Handling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleMessage(data) {
  switch (data.type) {
    case 'history':
      data.messages.forEach(m => renderMessage(m, true));
      scrollBottom();
      break;
    case 'message':
      renderMessage(data);
      scrollBottom();
      break;
    case 'system':
      appendSystem(data.text);
      if (data.users) updateUsers(data.users);
      scrollBottom();
      break;
    case 'users':
      updateUsers(data.users);
      break;
    case 'typing':
      showTyping(data.from);
      break;
    case 'error':
      if (!myName) {
        loginError.textContent = data.text;
        document.getElementById('join-btn').disabled = false;
      } else {
        appendSystem('âš  ' + data.text);
      }
      break;
  }
}

function renderMessage(msg, fromHistory = false) {
  const isMine    = msg.from === myName;
  const isPrivate = msg.private;
  const color     = colorFor(msg.from);

  // Group consecutive messages from same sender within 60s
  const grouped = !fromHistory && lastSender === msg.from && lastTime === msg.timestamp;
  lastSender = msg.from;
  lastTime   = msg.timestamp;

  const div = document.createElement('div');
  div.className = 'msg' + (isMine ? ' mine' : '') + (isPrivate ? ' private' : '') + (grouped ? ' grouped' : '');

  div.innerHTML = `
    <div class="msg-header">
      <span class="msg-name" style="color:${color}">${esc(msg.from)}${isPrivate && !isMine ? ' â†’ you' : isPrivate && isMine ? ' â†’ '+esc(msg.to) : ''}</span>
      <span class="msg-time">${msg.timestamp}</span>
    </div>
    <div class="msg-text">${esc(msg.text).replace(/\n/g, '<br>')}</div>
  `;
  messages.appendChild(div);
}

function appendSystem(text) {
  const div = document.createElement('div');
  div.className = 'msg system';
  div.innerHTML = `<div class="msg-text">${esc(text)}</div>`;
  messages.appendChild(div);
  lastSender = null;
}

function esc(str) {
  return String(str)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}

function scrollBottom() {
  requestAnimationFrame(() => { messages.scrollTop = messages.scrollHeight; });
}

// â”€â”€ Users sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateUsers(users) {
  onlineCount.textContent = users.length + ' online';
  userList.innerHTML = '';
  users.forEach(u => {
    const li = document.createElement('li');
    if (u === myName) li.classList.add('me');
    const color = colorFor(u);
    li.innerHTML = `
      <div class="user-avatar" style="background:${color}22;color:${color}">${initials(u)}</div>
      ${esc(u)}${u === myName ? ' <span style="color:var(--muted);font-size:.7rem">(you)</span>' : ''}
      <div class="online-pip"></div>
    `;
    if (u !== myName) {
      li.title = `Click to DM ${u}`;
      li.addEventListener('click', () => startDM(u));
    }
    userList.appendChild(li);
  });
}

// â”€â”€ DM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startDM(name) {
  dmTarget = name;
  dmTargetEl.textContent = name;
  dmBanner.classList.add('visible');
  msgInput.placeholder = `Private message to ${name}â€¦`;
  msgInput.focus();
}

dmClose.addEventListener('click', () => {
  dmTarget = null;
  dmBanner.classList.remove('visible');
  msgInput.placeholder = 'Type a messageâ€¦ (Enter to send)';
});

// â”€â”€ Typing â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let typingActive = {};
function showTyping(from) {
  typingActive[from] = true;
  renderTyping();
  clearTimeout(typingActive[from + '_t']);
  typingActive[from + '_t'] = setTimeout(() => {
    delete typingActive[from];
    delete typingActive[from + '_t'];
    renderTyping();
  }, 2500);
}

function renderTyping() {
  const names = Object.keys(typingActive).filter(k => !k.endsWith('_t'));
  if (!names.length) { typingEl.innerHTML = ''; return; }
  const label = names.length === 1
    ? `${names[0]} is typing`
    : `${names.join(', ')} are typing`;
  typingEl.innerHTML = `${label} <span class="typing-dots"><span></span><span></span><span></span></span>`;
}

// â”€â”€ Sending â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sendMessage() {
  const text = msgInput.value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;

  const payload = dmTarget
    ? { type: 'private', to: dmTarget, text }
    : { type: 'message', text };

  ws.send(JSON.stringify(payload));
  msgInput.value = '';
  autoResize();
}

msgInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
    return;
  }
  if (ws && ws.readyState === WebSocket.OPEN) {
    clearTimeout(typingTimer);
    ws.send(JSON.stringify({ type: 'typing' }));
    typingTimer = setTimeout(() => {}, 2000);
  }
});

sendBtn.addEventListener('click', sendMessage);

function autoResize() {
  msgInput.style.height = 'auto';
  msgInput.style.height = Math.min(msgInput.scrollHeight, 120) + 'px';
}
msgInput.addEventListener('input', autoResize);

// â”€â”€ Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setStatus(state) {
  statusDot.className = state;
  statusText.textContent = state;
}

// â”€â”€ Load saved server URL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const saved = localStorage.getItem('chatter_server');
if (saved) serverInput.value = saved;
serverInput.addEventListener('input', () => {
  localStorage.setItem('chatter_server', serverInput.value.trim());
});
</script>
</body>
</html>
